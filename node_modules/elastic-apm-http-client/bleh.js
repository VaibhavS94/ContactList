const http = require('http')
const zlib = require('zlib')
const ndjson = require('ndjson')
const HttpClient = require('./')

const server = http.createServer((req, res) => {
  const messages = []
  const stream = req
    .pipe(zlib.createGunzip())
    .pipe(ndjson.parse())

  stream.on('data', messages.push.bind(messages))
  stream.on('end', () => {
    console.log(messages.slice(1))
    res.writeHead(200, {
      'content-type': 'application/json'
    })
    res.end(JSON.stringify(messages))
  })
})

server.listen(8200)

const stream = new HttpClient({
  agentName: 'agent-name',
  agentVersion: '1.0.0',
  serviceName: 'service-name',
  userAgent: 'user-agent',
  serverUrl: 'http://localhost:8200',
  serverTimeout: 1000,
  time: 500
})

let i = 0
setInterval(() => {
  stream.sendSpan({ i: i++ })
}, 100)
